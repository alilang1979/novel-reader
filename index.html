<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说阅读器</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --content-width: min(800px, 90%);
            --reader-padding: 20px;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.8;
            color: var(--text-color);
            background-color: var(--bg-color);
        }

        .container {
            max-width: var(--content-width);
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 24px;
        }

        .reader {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: var(--reader-padding);
            margin-bottom: 20px;
        }

        #content {
            font-size: 18px;
            line-height: 1.8;
            color: var(--text-color);
            padding: 0 10px;
            min-height: 60vh;
            text-align: justify;
            word-break: break-word;
            hyphens: auto;
        }

        #content .chapter-title {
            text-align: center;
            margin-bottom: 1.5em;
            font-size: 1.5em;
            color: #222;
        }

        #content .chapter-content {
            margin: 0 auto;
            max-width: 90%;
        }

        #content p {
            margin-bottom: 1.2em;
            text-indent: 2em;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            padding: 20px 0;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
            min-width: 100px;
        }

        .btn:hover {
            background-color: #357abd;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 16px;
        }

        .error {
            color: #ff4444;
            padding: 20px;
            background-color: #fff8f8;
            border: 1px solid #ffdddd;
            border-radius: 4px;
            margin: 20px 0;
        }

        .error-details {
            font-family: monospace;
            background-color: #f8f8f8;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
        }

        .error h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .error p {
            margin: 0 0 15px 0;
            font-size: 16px;
        }

        .url-input-container {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .url-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 60%;
            max-width: 400px;
        }

        .url-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        @media (max-width: 600px) {
            :root {
                --content-width: 100%;
                --reader-padding: 10px;
            }

            .container {
                padding: 5px;
            }
            
            .header {
                padding: 10px 0;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .url-input-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .url-input {
                width: 90%;
                max-width: none;
                padding: 10px;
                font-size: 16px;
            }
            
            .reader {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 0;
            }
            
            #content {
                font-size: 16px;
                padding: 0 5px;
                line-height: 1.7;
                min-height: 70vh;
            }

            #content .chapter-content {
                max-width: 95%;
            }
            
            .controls {
                padding: 15px 0;
                margin-top: 15px;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 16px;
                min-width: 80px;
            }
            
            .error {
                padding: 15px;
                margin: 15px 0;
                font-size: 14px;
            }
            
            .error-details {
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>小说阅读器</h1>
            <div class="url-input-container">
                <input type="text" id="chapterUrl" placeholder="请输入章节URL" class="url-input">
                <button id="loadUrl" class="btn">加载章节</button>
            </div>
        </div>
        
        <div class="reader">
            <div id="content">
                <div class="loading">正在加载章节内容...</div>
            </div>
            <div class="controls">
                <button id="prevChapter" class="btn" disabled>上一章</button>
                <button id="nextChapter" class="btn" disabled>下一章</button>
            </div>
        </div>
    </div>

    <script>
class NovelReader {
    constructor() {
        this.proxyUrls = [
            "https://api.allorigins.win/raw?url=",
            "https://cors-anywhere.herokuapp.com/",
            "https://api.codetabs.com/v1/proxy?quest="
        ];
        this.currentProxyIndex = 0;
        this.baseUrl = "https://www.txtwl.com";
        this.currentChapterUrl = "/article_134_181251.html";
        this.content = document.getElementById('content');
        this.prevButton = document.getElementById('prevChapter');
        this.nextButton = document.getElementById('nextChapter');
        this.maxRetries = 3;
        this.urlInput = document.getElementById('chapterUrl');
        this.loadUrlButton = document.getElementById('loadUrl');
        
        this.initializeEventListeners();
        this.loadCurrentChapter();
    }

    initializeEventListeners() {
        this.prevButton.addEventListener('click', () => this.loadPreviousChapter());
        this.nextButton.addEventListener('click', () => this.loadNextChapter());
        this.loadUrlButton.addEventListener('click', () => this.loadFromUrl());
        this.urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.loadFromUrl();
            }
        });
    }

    async loadChapter(url, retryCount = 0) {
        this.content.innerHTML = '<div class="loading">正在加载章节内容...</div>';
        try {
            const fullUrl = url.startsWith('http') ? url : this.baseUrl + url;
            const proxyUrl = this.proxyUrls[this.currentProxyIndex];
            const response = await fetch(`${proxyUrl}${encodeURIComponent(fullUrl)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            
            // 提取章节标题
            const title = doc.querySelector('.j_chapterName')?.textContent || '未知章节';
            
            // 提取正文内容
            const contentElement = doc.querySelector('.j_readContent');
            
            if (!contentElement) {
                throw new Error("无法找到正文内容，请检查页面结构");
            }
            
            // 克隆内容元素以避免修改原始DOM
            const contentClone = contentElement.cloneNode(true);
            
            // 移除不需要的元素
            const elementsToRemove = contentClone.querySelectorAll('.admire-wrap, .report-btn');
            elementsToRemove.forEach(el => el.remove());
            
            const content = `
                <h1 class="chapter-title">${title}</h1>
                <div class="chapter-content">
                    ${contentClone.innerHTML}
                </div>
            `;
            
            this.content.innerHTML = content;
            this.currentChapterUrl = url;
            this.updateNavigationButtons();
            window.scrollTo(0, 0);
        } catch (error) {
            console.error("加载章节时出错:", error);
            
            if (retryCount < this.maxRetries) {
                console.log(`重试第 ${retryCount + 1} 次...`);
                await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                return this.loadChapter(url, retryCount + 1);
            }
            
            const errorDetails = {
                message: error.message,
                url: this.baseUrl + url,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                retryCount: retryCount
            };
            
            this.content.innerHTML = `
                <div class="error">
                    <h3>加载章节时出错</h3>
                    <p>${error.message}</p>
                    <div class="error-details">
                        请求URL: ${errorDetails.url}
                        时间: ${errorDetails.timestamp}
                        错误类型: ${error.name}
                        重试次数: ${errorDetails.retryCount}
                        浏览器信息: ${errorDetails.userAgent}
                    </div>
                </div>`;
        }
    }

    loadCurrentChapter() {
        this.loadChapter(this.currentChapterUrl);
    }

    async loadPreviousChapter() {
        this.prevButton.disabled = true;
        this.content.innerHTML = '<div class="loading">正在加载上一章...</div>';
        try {
            const fullUrl = this.currentChapterUrl.startsWith('http') 
                ? this.currentChapterUrl 
                : this.baseUrl + this.currentChapterUrl;
            const proxyUrl = this.proxyUrls[this.currentProxyIndex];
            const response = await fetch(`${proxyUrl}${encodeURIComponent(fullUrl)}`);
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            
            console.log('正在查找上一章链接...');
            const prevLink = doc.querySelector('.chapter-control a:first-child');
            if (prevLink && prevLink.getAttribute('href') && !prevLink.getAttribute('href').startsWith('javascript:')) {
                console.log('找到上一章链接:', prevLink.getAttribute('href'));
                this.loadChapter(prevLink.getAttribute('href'));
            } else {
                console.log('没有找到有效的上一章链接');
                this.prevButton.disabled = true;
                this.content.innerHTML = '<div class="error"><h3>无法加载上一章</h3><p>已经是第一章或无法找到上一章链接</p></div>';
            }
        } catch (error) {
            console.error('获取上一章链接失败:', error);
            this.prevButton.disabled = true;
            this.content.innerHTML = `<div class="error"><h3>加载失败</h3><p>获取上一章链接时出错: ${error.message}</p></div>`;
        }
    }

    async loadNextChapter() {
        this.nextButton.disabled = true;
        this.content.innerHTML = '<div class="loading">正在加载下一章...</div>';
        try {
            const fullUrl = this.currentChapterUrl.startsWith('http') 
                ? this.currentChapterUrl 
                : this.baseUrl + this.currentChapterUrl;
            const proxyUrl = this.proxyUrls[this.currentProxyIndex];
            const response = await fetch(`${proxyUrl}${encodeURIComponent(fullUrl)}`);
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            
            console.log('正在查找下一章链接...');
            const nextLink = doc.querySelector('.chapter-control a:last-child');
            if (nextLink && nextLink.getAttribute('href') && !nextLink.getAttribute('href').startsWith('javascript:')) {
                console.log('找到下一章链接:', nextLink.getAttribute('href'));
                this.loadChapter(nextLink.getAttribute('href'));
            } else {
                console.log('没有找到有效的下一章链接');
                this.nextButton.disabled = true;
                this.content.innerHTML = '<div class="error"><h3>无法加载下一章</h3><p>已经是最后一章或无法找到下一章链接</p></div>';
            }
        } catch (error) {
            console.error('获取下一章链接失败:', error);
            this.nextButton.disabled = true;
            this.content.innerHTML = `<div class="error"><h3>加载失败</h3><p>获取下一章链接时出错: ${error.message}</p></div>`;
        }
    }

    updateNavigationButtons() {
        this.prevButton.disabled = false;
        this.nextButton.disabled = false;
    }

    loadFromUrl() {
        const url = this.urlInput.value.trim();
        if (!url) {
            this.content.innerHTML = `<div class="error"><h3>输入错误</h3><p>请输入有效的章节URL</p></div>`;
            return;
        }

        try {
            const urlObj = new URL(url);
            if (!urlObj.pathname.includes('/article_')) {
                throw new Error('无效的章节URL，URL必须包含 /article_');
            }
            const chapterPath = urlObj.pathname + (urlObj.search || '');
            this.loadChapter(chapterPath);
        } catch (error) {
            this.content.innerHTML = `
                <div class="error">
                    <h3>URL格式错误</h3>
                    <p>${error.message}</p>
                    <div class="error-details">请输入完整的章节URL，例如：https://www.txtwl.com/article_xxx_xxx.html</div>
                </div>`;
        }
    }
}

// Initialize the novel reader when the page loads
document.addEventListener('DOMContentLoaded', () => {
    window.novelReader = new NovelReader();
});
    </script>
</body>
</html>
